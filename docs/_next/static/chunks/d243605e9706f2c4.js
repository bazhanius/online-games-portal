(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,8037,e=>{"use strict";e.i(30608);var t,i=e.i(40223),r=e.i(30232),o=e.i(97927),n=e.i(10861),s=e.i(40638),a=e.i(66343);let l=["white","black"],h=["a","b","c","d","e","f","g","h"],c=["1","2","3","4","5","6","7","8"],u=[...c].reverse(),d=h.flatMap(e=>c.map(t=>e+t)),f=e=>e.every(e=>e>=0&&e<=7)?d[8*e[0]+e[1]]:void 0,p=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],g=d.map(p),m=d.map((e,t)=>({key:e,pos:g[t]}));function b(e){let t,i=()=>(void 0===t&&(t=e()),t);return i.clear=()=>{t=void 0},i}let v=e=>"white"===e?"black":"white",_=(e,t)=>(e[0]-t[0])**2+(e[1]-t[1])**2,w=(e,t)=>e.role===t.role&&e.color===t.color,k=e=>(t,i)=>[(i?t[0]:7-t[0])*e.width/8,(i?7-t[1]:t[1])*e.height/8],y=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},C=(e,t,i=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${i})`},S=(e,t)=>{e.style.visibility=t?"visible":"hidden"},x=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.targetTouches?.[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,E=b(()=>!("ontouchstart"in window)&&["macintosh","firefox"].every(e=>navigator.userAgent.toLowerCase().includes(e))),M=e=>2===e.button&&!(e.ctrlKey&&E()),A=(e,t)=>{let i=document.createElement(e);return t&&(i.className=t),i};function P(e,t,i){let r=p(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[i.left+i.width*r[0]/8+i.width/16,i.top+i.height*(7-r[1])/8+i.height/16]}let T=(e,t)=>Math.abs(e-t),O=(e,t,i,r)=>T(e,i)*T(t,r)==2,L=(e,t,i,r)=>e===i!=(t===r),I=(e,t,i,r)=>T(e,i)===T(t,r)&&e!==i,R=e=>I(...e.orig.pos,...e.dest.pos),N=e=>L(...e.orig.pos,...e.dest.pos),q={pawn:e=>1>=T(e.orig.pos[0],e.dest.pos[0])&&(1===T(e.orig.pos[0],e.dest.pos[0])?e.dest.pos[1]===e.orig.pos[1]+("white"===e.color?1:-1):((e,t,i,r,o)=>{let n=o?1:-1;return e===i&&(r===t+n||r===t+2*n&&(o?t<=1:t>=6))})(...e.orig.pos,...e.dest.pos,"white"===e.color)),knight:e=>O(...e.orig.pos,...e.dest.pos),bishop:R,rook:N,queen:e=>R(e)||N(e),king:e=>((e,t,i,r)=>1===Math.max(T(e,i),T(t,r)))(...e.orig.pos,...e.dest.pos)||e.orig.pos[1]===e.dest.pos[1]&&e.orig.pos[1]===7*("white"!==e.color)&&(4===e.orig.pos[0]&&(2===e.dest.pos[0]&&e.rookFilesFriendlies.includes(0)||6===e.dest.pos[0]&&e.rookFilesFriendlies.includes(7))||e.rookFilesFriendlies.includes(e.dest.pos[0]))};function j(e,t){let i=e.pieces,r=i.get(t);if(!r||r.color===e.turnColor)return[];let o=r.color,n=new Map([...i].filter(([e,t])=>t.color===o)),s=new Map([...i].filter(([e,t])=>t.color===v(o))),a={orig:{key:t,pos:p(t)},role:r.role,allPieces:i,friendlies:n,enemies:s,color:o,rookFilesFriendlies:Array.from(i).filter(([e,t])=>e[1]===("white"===o?"1":"8")&&t.color===o&&"rook"===t.role).map(([e])=>p(e)[0]),lastMove:e.lastMove};return m.filter(t=>{let i;return i={...a,dest:t},q[r.role](i)&&e.premovable.additionalPremoveRequirements(i)}).map(e=>e.key)}function K(e,...t){e&&setTimeout(()=>e(...t),1)}function $(e){e.premovable.current&&(e.premovable.current=void 0,K(e.premovable.events.unset))}function D(e){let t=e.predroppable;t.current&&(t.current=void 0,K(t.events.unset))}function F(e,t,i){let r=e.pieces.get(t),o=e.pieces.get(i);if(t===i||!r)return!1;let n=o&&o.color!==r.color?o:void 0;return i===e.selected&&G(e),K(e.events.move,t,i,n),!function(e,t,i){if(!e.autoCastle)return!1;let r=e.pieces.get(t);if(!r||"king"!==r.role)return!1;let o=p(t),n=p(i);if(0!==o[1]&&7!==o[1]||o[1]!==n[1])return!1;4!==o[0]||e.pieces.has(i)||(6===n[0]?i=f([7,n[1]]):2===n[0]&&(i=f([0,n[1]])));let s=e.pieces.get(i);return!!s&&s.color===r.color&&"rook"===s.role&&((e.pieces.delete(t),e.pieces.delete(i),o[0]<n[0])?(e.pieces.set(f([6,n[1]]),r),e.pieces.set(f([5,n[1]]),s)):(e.pieces.set(f([2,n[1]]),r),e.pieces.set(f([3,n[1]]),s)),!0)}(e,t,i)&&(e.pieces.set(i,r),e.pieces.delete(t)),e.lastMove=[t,i],e.check=void 0,K(e.events.change),n||!0}function B(e,t,i,r){if(e.pieces.has(i))if(!r)return!1;else e.pieces.delete(i);return K(e.events.dropNewPiece,t,i),e.pieces.set(i,t),e.lastMove=[i],e.check=void 0,K(e.events.change),e.movable.dests=void 0,e.turnColor=v(e.turnColor),!0}function U(e,t,i){let r=F(e,t,i);return r&&(e.movable.dests=void 0,e.turnColor=v(e.turnColor),e.animation.current=void 0),r}function W(e,t,i){if(Z(e,t,i)){let r=U(e,t,i);if(r){let o=e.hold.stop();G(e);let n={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:o};return!0!==r&&(n.captured=r),K(e.movable.events.after,t,i,n),!0}}else if(Y(e,t,i)){var r;return r={ctrlKey:e.stats.ctrlKey},D(e),e.premovable.current=[t,i],K(e.premovable.events.set,t,i,r),G(e),!0}return G(e),!1}function H(e,t,i,r){var o,n,s,a,l,h,c;let u,d=e.pieces.get(t);if(d&&(o=e,n=t,s=i,(u=o.pieces.get(n))&&(n===s||!o.pieces.has(s))&&("both"===o.movable.color||o.movable.color===u.color&&o.turnColor===u.color)||r))e.pieces.delete(t),B(e,d,i,r),K(e.movable.events.afterNewPiece,d.role,i,{premove:!1,predrop:!1});else{let r,o;if(d&&(a=e,l=t,h=i,r=a.pieces.get(l),o=a.pieces.get(h),r&&(!o||o.color!==a.movable.color)&&a.predroppable.enabled&&("pawn"!==r.role||"1"!==h[1]&&"8"!==h[1])&&a.movable.color===r.color&&a.turnColor!==r.color)){c=d.role,$(e),e.predroppable.current={role:c,key:i},K(e.predroppable.events.set,c,i)}else $(e),D(e)}e.pieces.delete(t),G(e)}function z(e,t,i){if(K(e.events.select,t),e.selected)if(e.selected!==t||e.draggable.enabled){if((e.selectable.enabled||i)&&e.selected!==t&&W(e,e.selected,t)){e.stats.dragged=!1;return}}else{G(e),e.hold.cancel();return}(e.selectable.enabled||e.draggable.enabled)&&(V(e,t)||X(e,t))&&(Q(e,t),e.hold.start())}function Q(e,t){e.selected=t,X(e,t)?e.premovable.customDests||(e.premovable.dests=j(e,t)):e.premovable.dests=void 0}function G(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function V(e,t){let i=e.pieces.get(t);return!!i&&("both"===e.movable.color||e.movable.color===i.color&&e.turnColor===i.color)}let Z=(e,t,i)=>t!==i&&V(e,t)&&(e.movable.free||!!e.movable.dests?.get(t)?.includes(i));function X(e,t){let i=e.pieces.get(t);return!!i&&e.premovable.enabled&&e.movable.color===i.color&&e.turnColor!==i.color}let Y=(e,t,i)=>t!==i&&X(e,t)&&(e.premovable.customDests?.get(t)??j(e,t)).includes(i);function J(e){let t=e.premovable.current;if(!t)return!1;let i=t[0],r=t[1],o=!1;if(Z(e,i,r)){let t=U(e,i,r);if(t){let n={premove:!0};!0!==t&&(n.captured=t),K(e.movable.events.after,i,r,n),o=!0}}return $(e),o}function ee(e){$(e),D(e),G(e)}function et(e){e.movable.color=e.movable.dests=e.animation.current=void 0,ee(e)}function ei(e,t,i){let r=Math.floor(8*(e[0]-i.left)/i.width);t||(r=7-r);let o=7-Math.floor(8*(e[1]-i.top)/i.height);return t||(o=7-o),r>=0&&r<8&&o>=0&&o<8?f([r,o]):void 0}let er="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",eo={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},en={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function es(e){"start"===e&&(e=er);let t=new Map,i=7,r=0;for(let o of e)switch(o){case" ":case"[":return t;case"/":if(--i<0)return t;r=0;break;case"~":{let e=f([r-1,i]),o=e&&t.get(e);o&&(o.promoted=!0);break}default:{let e=o.charCodeAt(0);if(e<57)r+=e-48;else{let e=o.toLowerCase(),n=f([r,i]);n&&t.set(n,{role:eo[e],color:o===e?"black":"white"}),++r}}}return t}function ea(e,t){t.animation&&(eh(e.animation,t.animation),70>(e.animation.duration||0)&&(e.animation.enabled=!1))}function el(e,t){if(t.movable?.dests&&(e.movable.dests=void 0),t.drawable?.autoShapes&&(e.drawable.autoShapes=[]),eh(e,t),t.fen&&(e.pieces=es(t.fen),e.drawable.shapes=t.drawable?.shapes||[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(let[i,r]of e.pieces)"king"===r.role&&r.color===t&&(e.check=i)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Q(e,e.selected),ea(e,t),!e.movable.rookCastle&&e.movable.dests){let t="white"===e.movable.color?"1":"8",i="e"+t,r=e.movable.dests.get(i),o=e.pieces.get(i);r&&o&&"king"===o.role&&e.movable.dests.set(i,r.filter(e=>!(e==="a"+t&&r.includes("c"+t))&&!(e==="h"+t&&r.includes("g"+t))))}}function eh(e,t){for(let i in t)"__proto__"!==i&&"constructor"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)&&ec(e[i])&&ec(t[i])?eh(e[i],t[i]):e[i]=t[i])}function ec(e){if("object"!=typeof e||null===e)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}let eu=(e,t)=>t.animation.enabled?function(e,t){let i=new Map(t.pieces),r=e(t),o=function(e,t){let i,r,o,n=new Map,s=[],a=new Map,l=[],h=[],c=new Map;for(let[t,i]of e)c.set(t,ef(t,i));for(let e of d)i=t.pieces.get(e),r=c.get(e),i?r?w(i,r.piece)||(l.push(r),h.push(ef(e,i))):h.push(ef(e,i)):r&&l.push(r);for(let e of h)(r=ep(e,l.filter(t=>w(e.piece,t.piece))))&&(o=[r.pos[0]-e.pos[0],r.pos[1]-e.pos[1]],n.set(e.key,o.concat(o)),s.push(r.key));for(let e of l)s.includes(e.key)||a.set(e.key,e.piece);return{anims:n,fadings:a}}(i,t);if(o.anims.size||o.fadings.size){let e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:o},e||function e(t,i){let r=t.animation.current;if(void 0===r){t.dom.destroyed||t.dom.redrawNow();return}let o=1-(i-r.start)*r.frequency;if(o<=0)t.animation.current=void 0,t.dom.redrawNow();else{let i=eg(o);for(let e of r.plan.anims.values())e[2]=e[0]*i,e[3]=e[1]*i;t.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>e(t,i))}}(t,performance.now())}else t.dom.redraw();return r}(e,t):ed(e,t);function ed(e,t){let i=e(t);return t.dom.redraw(),i}let ef=(e,t)=>({key:e,pos:p(e),piece:t}),ep=(e,t)=>t.sort((t,i)=>_(e.pos,t.pos)-_(e.pos,i.pos))[0],eg=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,em=["green","red","blue","yellow"];function eb(e,t){e.drawable.current&&(e.drawable.current.pos=x(t))}function ev(e){let t=e.drawable.current;t&&(t.mouseSq&&function(e,t){let i=e.shapes.find(e=>ew(e,t));i&&(e.shapes=e.shapes.filter(e=>!ew(e,t))),i&&i.brush===t.brush||e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),ek(e)}(e.drawable,t),e_(e))}function e_(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}let ew=(e,t)=>e.orig===t.orig&&e.dest===t.dest;function ek(e){e.onChange&&e.onChange(e.shapes)}function ey(e){requestAnimationFrame(()=>{let t=e.draggable.current;if(!t)return;e.animation.current?.plan.anims.has(t.orig)&&(e.animation.current=void 0);let i=e.pieces.get(t.orig);if(i&&w(i,t.piece)){if(!t.started&&_(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if("function"==typeof t.element){let e=t.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),t.element=e}let i=e.dom.bounds();y(t.element,[t.pos[0]-i.left-i.width/16,t.pos[1]-i.top-i.height/16]),t.keyHasChanged||(t.keyHasChanged=t.orig!==ei(t.pos,"white"===e.orientation,i))}}else ex(e);ey(e)})}function eC(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=x(t))}function eS(e,t){let i=e.draggable.current;if(!i)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&i.originTarget!==t.target&&!i.newPiece){e.draggable.current=void 0;return}$(e),D(e);let r=ei(x(t)||i.pos,"white"===e.orientation,e.dom.bounds());r&&i.started&&i.orig!==r?i.newPiece?H(e,i.orig,r,i.force):(e.stats.ctrlKey=t.ctrlKey,W(e,i.orig,r)&&(e.stats.dragged=!0)):i.newPiece?e.pieces.delete(i.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(i.orig),K(e.events.change)),(i.orig===i.previouslySelected||i.keyHasChanged)&&(i.orig===r||!r)?G(e):e.selectable.enabled||G(e),eE(e),e.draggable.current=void 0,e.dom.redraw()}function ex(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,G(e),eE(e),e.dom.redraw())}function eE(e){let t=e.dom.elements;t.ghost&&S(t.ghost,!1)}function eM(e,t){let i=e.dom.elements.board.firstChild;for(;i;){if(i.cgKey===t&&"PIECE"===i.tagName)return i;i=i.nextSibling}}function eA(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function eP({orig:e,dest:t,brush:i,piece:r,modifiers:o,customSvg:n,label:s,below:a},l,h,c,u,d){return[c.width,c.height,h,u&&"pendingErase",d,e,t,i,l&&"-",r&&eT(r),o&&eO(o),n&&`custom-${eL(n.html)},${n.center?.[0]??"o"}`,s&&`label-${eL(s.text)}`,a&&"below"].filter(e=>e).join(",")}let eT=e=>[e.color,e.role,e.scale].filter(e=>e).join(","),eO=e=>[e.lineWidth,e.hilite].filter(e=>e).join(",");function eL(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i)>>>0;return t.toString()}let eI=(e,t)=>"white"===t?e:[7-e[0],7-e[1]],eR=(e,t)=>(e%t+t)%t,eN=e=>[...e].some(t=>[-3,-2,-1,1,2,3].some(i=>e.has(eR(t+i,16)))),eq=(e,t)=>!!e&&t.has(e)&&eN(t.get(e)),ej=e=>document.createElementNS("http://www.w3.org/2000/svg",e),eK=(e,t)=>e&&t.has(e)?t.get(e).size:0;function e$(e,t){for(let i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.setAttribute(i,t[i]);return e}let eD=(e,t)=>t?{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(e=>e).join("")}:e;function eF(e){let t=e.modifiers?.hilite;return{key:t&&`hilite-${t.replace("#","")}`,color:t}}let eB=(e,t,i)=>(e.opacity||1)*(i?.6:t?.9:1);function eU(e,t){let i=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*i,(3.5-e[1])*r]}let eW=e=>eR(Math.round(8*e/Math.PI),16),eH=(e,t)=>Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;function ez(e,t,i){let r=Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((e,t)=>e+t*t,0)),o=eH(e,t);if(i&&(r-=33/64,eN(i))){r-=10/64;let e=eW(o);1&e&&[-1,1].some(t=>i.has(eR(e+t,16)))&&(r-=.4)}return[e[0]-Math.cos(o)*r,e[1]-Math.sin(o)*r].map(e=>e+.5)}function eQ(e,t){let i,r,o=e$(ej("svg"),{class:e,viewBox:t?"-4 -4 8 8":"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"});return t&&o.appendChild((i=ej("defs"),(r=e$(ej("filter"),{id:"cg-filter-blur"})).appendChild(e$(ej("feGaussianBlur"),{stdDeviation:"0.013"})),i.appendChild(r),i)),o.appendChild(ej("g")),o}function eG(e,t,i){let r,o=A("coords",t);return e.forEach((e,t)=>{(r=A("coord",`coord-${t%2==+("white"!==i)?"light":"dark"}`)).textContent=e,o.appendChild(r)}),o}function eV(e,t,i,r){return e.addEventListener(t,i,r),()=>e.removeEventListener(t,i,r)}let eZ=(e,t,i)=>r=>{e.drawable.current?e.drawable.enabled&&i(e,r):e.viewOnly||t(e,r)};function eX(e){let t=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,r=t.height/t.width,o=8*Math.floor(t.width*window.devicePixelRatio/8)/window.devicePixelRatio,n=o*r;i.style.width=o+"px",i.style.height=n+"px",e.dom.bounds.clear(),e.addDimensionsCssVarsTo?.style.setProperty("---cg-width",o+"px"),e.addDimensionsCssVarsTo?.style.setProperty("---cg-height",n+"px")}let eY=e=>"PIECE"===e.tagName,eJ=e=>"SQUARE"===e.tagName;function e0(e,t){for(let i of t)e.dom.elements.board.removeChild(i)}function e1(e,t){let i=e[1];return`${t?10-i:3+i}`}let e2=e=>`${e.color} ${e.role}`,e6=(e,t)=>e.lastMove?.[1]&&!e.pieces.has(e.lastMove[1])&&"e"===e.lastMove[0][0]&&["h","a"].includes(e.lastMove[1][0])&&e.lastMove[0][1]===e.lastMove[1][1]&&((e,t,i,r)=>{let o=i-e,n=r-t;if(o&&n&&Math.abs(o)!==Math.abs(n))return[];let s=Math.sign(o),a=Math.sign(n),l=[],h=e+s,c=t+a;for(;h!==i||c!==r;)l.push([h,c]),h+=s,c+=a;return l.map(f).filter(e=>void 0!==e)})(...p(e.lastMove[0]),...p(e.lastMove[1])).some(t=>e.pieces.has(t))?(t>e.lastMove[0]?"g":"c")+t[1]:t;function e3(e,t,i){let r=e.get(t);r?e.set(t,`${r} ${i}`):e.set(t,i)}function e8(e,t,i){let r=e.get(t);r?r.push(i):e.set(t,[i])}function e4(e,t,i,r){var o=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(o,e4.prototype),o.expected=t,o.found=i,o.location=r,o.name="SyntaxError",o}function e5(){this.constructor=e4}function e7(e,t,i){return(i=i||" ",e.length>t)?e:(t-=e.length,e+(i+=i.repeat(t)).slice(0,t))}function e9(e,t){return(e<<t|e>>64n-t)&0xffffffffffffffffn}function te(e,t){return e*t&0xffffffffffffffffn}e5.prototype=Error.prototype,e4.prototype=new e5,e4.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var i,r=null;for(i=0;i<e.length;i++)if(e[i].source===this.location.source){r=e[i].text.split(/\r\n|\n|\r/g);break}var o=this.location.start,n=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(o):o,s=this.location.source+":"+n.line+":"+n.column;if(r){var a=this.location.end,l=e7("",n.line.toString().length," "),h=r[o.line-1],c=(o.line===a.line?a.column:h.length+1)-o.column||1;t+="\n --> "+s+"\n"+l+" |\n"+n.line+" | "+h+"\n"+l+" | "+e7("",o.column-1," ")+e7("",c,"^")}else t+="\n at "+s}return t},e4.buildMessage=function(e,t){var i={literal:function(e){return'"'+o(e.text)+'"'},class:function(e){var t=e.parts.map(function(e){return Array.isArray(e)?n(e[0])+"-"+n(e[1]):n(e)});return"["+(e.inverted?"^":"")+t.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(e){return e.description}};function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function o(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+r(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+r(e)})}function n(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+r(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+r(e)})}function s(e){return i[e.type](e)}return"Expected "+function(e){var t,i,r=e.map(s);if(r.sort(),r.length>0){for(t=1,i=1;t<r.length;t++)r[t-1]!==r[t]&&(r[i]=r[t],i++);r.length=i}switch(r.length){case 1:return r[0];case 2:return r[0]+" or "+r[1];default:return r.slice(0,-1).join(", ")+", or "+r[r.length-1]}}(e)+" but "+(t?'"'+o(t)+'"':"end of input")+" found."};let tt=(t=0xa187eb39cdcaed8f31c4b365b102e01en,function(){let e=BigInt(0xffffffffffffffffn&t),i=BigInt(t>>64n&0xffffffffffffffffn),r=te(e9(te(e,5n),7n),9n);return i^=e,e=(e9(e,24n)^i^i<<16n)&0xffffffffffffffffn,t=(i=e9(i,37n))<<64n|e,r}),ti=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>tt()))),tr=Array.from({length:8},()=>tt()),to=Array.from({length:16},()=>tt()),tn=tt(),ts="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ta{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(e,t){const{color:i,piece:r,from:o,to:n,flags:s,captured:a,promotion:l}=t,h=tC(o),c=tC(n);for(const o in this.color=i,this.piece=r,this.from=h,this.to=c,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=h+c,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="",th)th[o]&s&&(this.flags+=tl[o]);a&&(this.captured=a),l&&(this.promotion=l,this.lan+=l)}isCapture(){return this.flags.indexOf(tl.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(tl.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(tl.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(tl.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(tl.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(tl.BIG_PAWN)>-1}}let tl={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},th={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},tc={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},tu={...tc,WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},td={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},tf={b:[16,32,17,15],w:[-16,-32,-17,-15]},tp={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},tg=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],tm=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],tb={p:1,n:2,b:4,r:8,q:16,k:32},tv=["n","b","r","q"],t_={k:th.KSIDE_CASTLE,q:th.QSIDE_CASTLE},tw={w:[{square:td.a1,flag:th.QSIDE_CASTLE},{square:td.h1,flag:th.KSIDE_CASTLE}],b:[{square:td.a8,flag:th.QSIDE_CASTLE},{square:td.h8,flag:th.KSIDE_CASTLE}]},tk={b:1,w:6};function ty(e){return -1!=="0123456789".indexOf(e)}function tC(e){let t=15&e,i=e>>4;return"abcdefgh".substring(t,t+1)+"87654321".substring(i,i+1)}function tS(e){return"w"===e?"b":"w"}function tx(e,t,i,r,o,n,s=th.NORMAL){let a=r>>4;if("p"===o&&(7===a||0===a))for(let a=0;a<tv.length;a++){let l=tv[a];e.push({color:t,from:i,to:r,piece:o,captured:n,promotion:l,flags:s|th.PROMOTION})}else e.push({color:t,from:i,to:r,piece:o,captured:n,flags:s})}function tE(e){let t=e.charAt(0);if(t>="a"&&t<="h"){if(e.match(/[a-h]\d.*[a-h]\d/))return;return"p"}return"o"===(t=t.toLowerCase())?"k":t}function tM(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class tA{_board=Array(128);_turn="w";_header={};_kings={w:-1,b:-1};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(e=ts,{skipValidation:t=!1}={}){this.load(e,{skipValidation:t})}clear({preserveHeaders:e=!1}={}){this._board=Array(128),this._kings={w:-1,b:-1},this._turn="w",this._castling={w:0,b:0},this._epSquare=-1,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{...tu},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(e,{skipValidation:t=!1,preserveHeaders:i=!1}={}){let r=e.split(/\s+/);if(r.length>=2&&r.length<6&&(e=r.concat(["-","-","0","1"].slice(-(6-r.length))).join(" ")),r=e.split(/\s+/),!t){let{ok:t,error:i}=function(e){let t=e.split(/\s+/);if(6!==t.length)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let i=parseInt(t[5],10);if(isNaN(i)||i<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let r=parseInt(t[4],10);if(isNaN(r)||r<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let o=t[0].split("/");if(8!==o.length)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let e=0;e<o.length;e++){let t=0,i=!1;for(let r=0;r<o[e].length;r++)if(ty(o[e][r])){if(i)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};t+=parseInt(o[e][r],10),i=!0}else{if(!/^[prnbqkPRNBQK]$/.test(o[e][r]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};t+=1,i=!1}if(8!==t)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if("3"==t[3][1]&&"w"==t[1]||"6"==t[3][1]&&"b"==t[1])return{ok:!1,error:"Invalid FEN: illegal en-passant square"};for(let{color:e,regex:i}of[{color:"white",regex:/K/g},{color:"black",regex:/k/g}]){if(!i.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${e} king`};if((t[0].match(i)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${e} kings`}}return Array.from(o[0]+o[7]).some(e=>"P"===e.toUpperCase())?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}(e);if(!t)throw Error(i)}let o=r[0],n=0;this.clear({preserveHeaders:i});for(let e=0;e<o.length;e++){let t=o.charAt(e);if("/"===t)n+=8;else if(ty(t))n+=parseInt(t,10);else{let e=t<"a"?"w":"b";this._put({type:t.toLowerCase(),color:e},tC(n)),n++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=th.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=th.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=th.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=th.QSIDE_CASTLE),this._epSquare="-"===r[3]?-1:td[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._hash=this._computeHash(),this._updateSetup(e),this._incPositionCount()}fen({forceEnpassantSquare:e=!1}={}){let t=0,i="";for(let e=td.a8;e<=td.h1;e++){if(this._board[e]){t>0&&(i+=t,t=0);let{color:r,type:o}=this._board[e];i+="w"===r?o.toUpperCase():o.toLowerCase()}else t++;e+1&136&&(t>0&&(i+=t),e!==td.h1&&(i+="/"),t=0,e+=8)}let r="";this._castling.w&th.KSIDE_CASTLE&&(r+="K"),this._castling.w&th.QSIDE_CASTLE&&(r+="Q"),this._castling.b&th.KSIDE_CASTLE&&(r+="k"),this._castling.b&th.QSIDE_CASTLE&&(r+="q"),r=r||"-";let o="-";if(-1!==this._epSquare)if(e)o=tC(this._epSquare);else{let e=this._epSquare+("w"===this._turn?16:-16);for(let t of[e+1,e-1]){if(136&t)continue;let e=this._turn;if(this._board[t]?.color===e&&this._board[t]?.type==="p"){this._makeMove({color:e,from:t,to:this._epSquare,piece:"p",captured:"p",flags:th.EP_CAPTURE});let i=!this._isKingAttacked(e);if(this._undoMove(),i){o=tC(this._epSquare);break}}}}return[i,this._turn,r,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(e){if(!this._board[e])return 0n;let{color:t,type:i}=this._board[e];return ti[({w:0,b:1})[t]][({p:0,n:1,b:2,r:3,q:4,k:5})[i]][e]}_epKey(){return -1===this._epSquare?0n:tr[7&this._epSquare]}_castlingKey(){return to[this._castling.w>>5|this._castling.b>>3]}_computeHash(){let e=0n;for(let t=td.a8;t<=td.h1;t++){if(136&t){t+=7;continue}this._board[t]&&(e^=this._pieceKey(t))}return e^=this._epKey(),e^=this._castlingKey(),"b"===this._turn&&(e^=tn),e}_updateSetup(e){this._history.length>0||(e!==ts?(this._header.SetUp="1",this._header.FEN=e):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(ts)}get(e){return this._board[td[e]]}findPiece(e){let t=[];for(let i=td.a8;i<=td.h1;i++){if(136&i){i+=7;continue}this._board[i]&&this._board[i]?.color===e.color&&this._board[i].color===e.color&&this._board[i].type===e.type&&t.push(tC(i))}return t}put({type:e,color:t},i){return!!this._put({type:e,color:t},i)&&(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0)}_set(e,t){this._hash^=this._pieceKey(e),this._board[e]=t,this._hash^=this._pieceKey(e)}_put({type:e,color:t},i){if(-1==="pnbrqkPNBRQK".indexOf(e.toLowerCase())||!(i in td))return!1;let r=td[i];if("k"==e&&-1!=this._kings[t]&&this._kings[t]!=r)return!1;let o=this._board[r];return o&&"k"===o.type&&(this._kings[o.color]=-1),this._set(r,{type:e,color:t}),"k"===e&&(this._kings[t]=r),!0}_clear(e){this._hash^=this._pieceKey(e),delete this._board[e]}remove(e){let t=this.get(e);return this._clear(td[e]),t&&"k"===t.type&&(this._kings[t.color]=-1),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){this._hash^=this._castlingKey();let e=this._board[td.e1]?.type==="k"&&this._board[td.e1]?.color==="w",t=this._board[td.e8]?.type==="k"&&this._board[td.e8]?.color==="b";e&&this._board[td.a1]?.type==="r"&&this._board[td.a1]?.color==="w"||(this._castling.w&=-65),e&&this._board[td.h1]?.type==="r"&&this._board[td.h1]?.color==="w"||(this._castling.w&=-33),t&&this._board[td.a8]?.type==="r"&&this._board[td.a8]?.color==="b"||(this._castling.b&=-65),t&&this._board[td.h8]?.type==="r"&&this._board[td.h8]?.color==="b"||(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(-1===this._epSquare)return;let e=this._epSquare+("w"===this._turn?-16:16),t=this._epSquare+("w"===this._turn?16:-16);if(null!==this._board[e]||null!==this._board[this._epSquare]||this._board[t]?.color!==tS(this._turn)||this._board[t]?.type!=="p"){this._hash^=this._epKey(),this._epSquare=-1;return}[t+1,t-1].some(e=>!(136&e)&&this._board[e]?.color===this._turn&&this._board[e]?.type==="p")||(this._hash^=this._epKey(),this._epSquare=-1)}_attacked(e,t,i){let r=[];for(let o=td.a8;o<=td.h1;o++){if(136&o){o+=7;continue}if(void 0===this._board[o]||this._board[o].color!==e)continue;let n=this._board[o],s=o-t;if(0===s)continue;let a=s+119;if(tg[a]&tb[n.type]){if("p"===n.type){if(s>0&&"w"===n.color||s<=0&&"b"===n.color)if(!i)return!0;else r.push(tC(o));continue}if("n"===n.type||"k"===n.type)if(!i)return!0;else{r.push(tC(o));continue}let e=tm[a],l=o+e,h=!1;for(;l!==t;){if(null!=this._board[l]){h=!0;break}l+=e}if(!h)if(!i)return!0;else{r.push(tC(o));continue}}}return!!i&&r}attackers(e,t){return t?this._attacked(t,td[e],!0):this._attacked(this._turn,td[e],!0)}_isKingAttacked(e){let t=this._kings[e];return -1!==t&&this._attacked(tS(e),t)}hash(){return this._hash.toString(16)}isAttacked(e,t){return this._attacked(t,td[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&0===this._moves().length}isStalemate(){return!this.isCheck()&&0===this._moves().length}isInsufficientMaterial(){let e={b:0,n:0,r:0,q:0,k:0,p:0},t=[],i=0,r=0;for(let o=td.a8;o<=td.h1;o++){if(r=(r+1)%2,136&o){o+=7;continue}let n=this._board[o];n&&(e[n.type]=n.type in e?e[n.type]+1:1,"b"===n.type&&t.push(r),i++)}if(2===i||3===i&&(1===e.b||1===e.n))return!0;if(i===e.b+2){let e=0,i=t.length;for(let r=0;r<i;r++)e+=t[r];if(0===e||e===i)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:e=!1,square:t,piece:i}={}){let r=this._moves({square:t,piece:i});return e?r.map(e=>new ta(this,e)):r.map(e=>this._moveToSan(e,r))}_moves({legal:e=!0,piece:t,square:i}={}){let r=i?i.toLowerCase():void 0,o=t?.toLowerCase(),n=[],s=this._turn,a=tS(s),l=td.a8,h=td.h1,c=!1;if(r)if(!(r in td))return[];else l=h=td[r],c=!0;for(let e=l;e<=h;e++){let t;if(136&e){e+=7;continue}if(!this._board[e]||this._board[e].color===a)continue;let{type:i}=this._board[e];if("p"===i){if(o&&o!==i)continue;t=e+tf[s][0],!this._board[t]&&(tx(n,s,e,t,"p"),t=e+tf[s][1],tk[s]!==e>>4||this._board[t]||tx(n,s,e,t,"p",void 0,th.BIG_PAWN));for(let i=2;i<4;i++)136&(t=e+tf[s][i])||(this._board[t]?.color===a?tx(n,s,e,t,"p",this._board[t].type,th.CAPTURE):t===this._epSquare&&tx(n,s,e,t,"p","p",th.EP_CAPTURE))}else{if(o&&o!==i)continue;for(let r=0,o=tp[i].length;r<o;r++){let o=tp[i][r];for(t=e;!(136&(t+=o));){if(this._board[t]){if(this._board[t].color===s)break;tx(n,s,e,t,i,this._board[t].type,th.CAPTURE);break}if(tx(n,s,e,t,i),"n"===i||"k"===i)break}}}}if((void 0===o||"k"===o)&&(!c||h===this._kings[s])){if(this._castling[s]&th.KSIDE_CASTLE){let e=this._kings[s],t=e+2;this._board[e+1]||this._board[t]||this._attacked(a,this._kings[s])||this._attacked(a,e+1)||this._attacked(a,t)||tx(n,s,this._kings[s],t,"k",void 0,th.KSIDE_CASTLE)}if(this._castling[s]&th.QSIDE_CASTLE){let e=this._kings[s],t=e-2;this._board[e-1]||this._board[e-2]||this._board[e-3]||this._attacked(a,this._kings[s])||this._attacked(a,e-1)||this._attacked(a,t)||tx(n,s,this._kings[s],t,"k",void 0,th.QSIDE_CASTLE)}}if(!e||-1===this._kings[s])return n;let u=[];for(let e=0,t=n.length;e<t;e++)this._makeMove(n[e]),this._isKingAttacked(s)||u.push(n[e]),this._undoMove();return u}move(e,{strict:t=!1}={}){let i=null;if("string"==typeof e)i=this._moveFromSan(e,t);else if(null===e)i=this._moveFromSan("--",t);else if("object"==typeof e){let t=this._moves();for(let r=0,o=t.length;r<o;r++)if(e.from===tC(t[r].from)&&e.to===tC(t[r].to)&&(!("promotion"in t[r])||e.promotion===t[r].promotion)){i=t[r];break}}if(!i)if("string"==typeof e)throw Error(`Invalid move: ${e}`);else throw Error(`Invalid move: ${JSON.stringify(e)}`);if(this.isCheck()&&i.flags&th.NULL_MOVE)throw Error("Null move not allowed when in check");let r=new ta(this,i);return this._makeMove(i),this._incPositionCount(),r}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(e,t){this._hash^=this._pieceKey(e),this._board[t]=this._board[e],delete this._board[e],this._hash^=this._pieceKey(t)}_makeMove(e){let t=this._turn,i=tS(t);if(this._push(e),e.flags&th.NULL_MOVE){"b"===t&&this._moveNumber++,this._halfMoves++,this._turn=i,this._epSquare=-1;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),e.captured&&(this._hash^=this._pieceKey(e.to)),this._movePiece(e.from,e.to),e.flags&th.EP_CAPTURE&&("b"===this._turn?this._clear(e.to-16):this._clear(e.to+16)),e.promotion&&(this._clear(e.to),this._set(e.to,{type:e.promotion,color:t})),"k"===this._board[e.to].type){if(this._kings[t]=e.to,e.flags&th.KSIDE_CASTLE){let t=e.to-1,i=e.to+1;this._movePiece(i,t)}else if(e.flags&th.QSIDE_CASTLE){let t=e.to+1,i=e.to-2;this._movePiece(i,t)}this._castling[t]=0}if(this._castling[t]){for(let i=0,r=tw[t].length;i<r;i++)if(e.from===tw[t][i].square&&this._castling[t]&tw[t][i].flag){this._castling[t]^=tw[t][i].flag;break}}if(this._castling[i]){for(let t=0,r=tw[i].length;t<r;t++)if(e.to===tw[i][t].square&&this._castling[i]&tw[i][t].flag){this._castling[i]^=tw[i][t].flag;break}}if(this._hash^=this._castlingKey(),e.flags&th.BIG_PAWN){let r;r="b"===t?e.to-16:e.to+16,(e.to-1&136||this._board[e.to-1]?.type!=="p"||this._board[e.to-1]?.color!==i)&&(e.to+1&136||this._board[e.to+1]?.type!=="p"||this._board[e.to+1]?.color!==i)?this._epSquare=-1:(this._epSquare=r,this._hash^=this._epKey())}else this._epSquare=-1;"p"===e.piece||e.flags&(th.CAPTURE|th.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,"b"===t&&this._moveNumber++,this._turn=i,this._hash^=tn}undo(){let e=this._hash,t=this._undoMove();if(t){let i=new ta(this,t);return this._decPositionCount(e),i}return null}_undoMove(){let e=this._history.pop();if(void 0===e)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=tn;let i=this._turn,r=tS(i);if(t.flags&th.NULL_MOVE)return t;if(this._movePiece(t.to,t.from),t.piece&&(this._clear(t.from),this._set(t.from,{type:t.piece,color:i})),t.captured)if(t.flags&th.EP_CAPTURE){let e;e="b"===i?t.to-16:t.to+16,this._set(e,{type:"p",color:r})}else this._set(t.to,{type:t.captured,color:r});if(t.flags&(th.KSIDE_CASTLE|th.QSIDE_CASTLE)){let e,i;t.flags&th.KSIDE_CASTLE?(e=t.to+1,i=t.to-1):(e=t.to-2,i=t.to+1),this._movePiece(i,e)}return t}pgn({newline:e="\n",maxWidth:t=0}={}){let i=[],r=!1;for(let t in this._header)this._header[t]&&i.push(`[${t} "${this._header[t]}"]`+e),r=!0;r&&this._history.length&&i.push(e);let o=e=>{let t=this._comments[this.fen()];if(void 0!==t){let i=e.length>0?" ":"";e=`${e}${i}{${t}}`}return e},n=[];for(;this._history.length>0;)n.push(this._undoMove());let s=[],a="";for(0===n.length&&s.push(o(""));n.length>0;){a=o(a);let e=n.pop();if(!e)break;if(this._history.length||"b"!==e.color)"w"===e.color&&(a.length&&s.push(a),a=this._moveNumber+".");else{let e=`${this._moveNumber}. ...`;a=a?`${a} ${e}`:e}a=a+" "+this._moveToSan(e,this._moves({legal:!0})),this._makeMove(e)}if(a.length&&s.push(o(a)),s.push(this._header.Result||"*"),0===t)return i.join("")+s.join(" ");let l=function(){return i.length>0&&" "===i[i.length-1]&&(i.pop(),!0)},h=0;for(let r=0;r<s.length;r++){if(h+s[r].length>t&&s[r].includes("{")){h=function(r,o){for(let n of o.split(" "))if(n){if(r+n.length>t){for(;l();)r--;i.push(e),r=0}i.push(n),r+=n.length,i.push(" "),r++}return l()&&r--,r}(h,s[r]);continue}h+s[r].length>t&&0!==r?(" "===i[i.length-1]&&i.pop(),i.push(e),h=0):0!==r&&(i.push(" "),h++),i.push(s[r]),h+=s[r].length}return i.join("")}header(...e){for(let t=0;t<e.length;t+=2)"string"==typeof e[t]&&"string"==typeof e[t+1]&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t??tc[e]??null,this.getHeaders()}removeHeader(e){return e in this._header&&(this._header[e]=tc[e]||null,!0)}getHeaders(){let e={};for(let[t,i]of Object.entries(this._header))null!==i&&(e[t]=i);return e}loadPgn(e,{strict:t=!1,newlineChar:i="\r?\n"}={}){"\r?\n"!==i&&(e=e.replace(RegExp(i,"g"),"\n"));let r=function(e,t){var i,r,o,n,s={},a=(t=void 0!==t?t:{}).grammarSource,l={pgn:eC},h=eC,c="O-O-O",u="0-0-0",d="1/2-1/2",f=/^[a-zA-Z]/,p=/^[^"]/,g=/^[0-9]/,m=/^[.]/,b=/^[a-zA-Z1-8\-=]/,v=/^[+#]/,_=/^[!?]/,w=/^[^}]/,k=/^[^\r\n]/,y=/^[ \t\r\n]/,C=e_("tag pair"),S=eb("[",!1),x=eb('"',!1),E=eb("]",!1),M=e_("tag name"),A=ev([["a","z"],["A","Z"]],!1,!1),P=e_("tag value"),T=ev(['"'],!0,!1),O=e_("move number"),L=ev([["0","9"]],!1,!1),I=eb(".",!1),R=ev(["."],!1,!1),N=e_("standard algebraic notation"),q=eb("O-O-O",!1),j=eb("O-O",!1),K=eb("0-0-0",!1),$=eb("0-0",!1),D=ev([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),F=ev(["+","#"],!1,!1),B=e_("suffix annotation"),U=ev(["!","?"],!1,!1),W=e_("NAG"),H=eb("$",!1),z=e_("brace comment"),Q=eb("{",!1),G=ev(["}"],!0,!1),V=eb("}",!1),Z=e_("rest of line comment"),X=eb(";",!1),Y=ev(["\r","\n"],!0,!1),J=e_("variation"),ee=eb("(",!1),et=eb(")",!1),ei=e_("game termination marker"),er=eb("1-0",!1),eo=eb("0-1",!1),en=eb("1/2-1/2",!1),es=eb("*",!1),ea=e_("whitespace"),el=ev([" ","	","\r","\n"],!1,!1),eh=function(e,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){let i=e.variations[0];if(!i){e.comment=t.marker.comment;break}e=i}}return{headers:e,root:t.root,result:(t.marker&&t.marker.result)??void 0}},ec=function(e,t){return function(...e){let[t,...i]=e,r=t;for(let e of i)null!==e&&(r.variations=[e,...e.variations],e.variations=[],r=e);return t}(null!==e?{comment:e,variations:[]}:{variations:[]},...t.flat())},eu=function(e,t,i,r,o){let n;return n={move:e,variations:o},t&&(n.suffix=t),i&&(n.nag=i),null!==r&&(n.comment=r),n},ed=0|t.peg$currPos,ef=[{line:1,column:1}],ep=ed,eg=t.peg$maxFailExpected||[],em=0|t.peg$silentFails;if(t.startRule){if(!(t.startRule in l))throw Error("Can't start parsing from rule \""+t.startRule+'".');h=l[t.startRule]}function eb(e,t){return{type:"literal",text:e,ignoreCase:t}}function ev(e,t,i){return{type:"class",parts:e,inverted:t,ignoreCase:i}}function e_(e){return{type:"other",description:e}}function ew(t){var i,r=ef[t];if(r)return r;if(t>=ef.length)i=ef.length-1;else for(i=t;!ef[--i];);for(r={line:(r=ef[i]).line,column:r.column};i<t;)10===e.charCodeAt(i)?(r.line++,r.column=1):r.column++,i++;return ef[t]=r,r}function ek(e,t,i){var r=ew(e),o=ew(t);return{source:a,start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:o.line,column:o.column}}}function ey(e){ed<ep||(ed>ep&&(ep=ed,eg=[]),eg.push(e))}function eC(){var t;return t=function(){var e,t;for(e=[],t=eS();t!==s;)e.push(t),t=eS();return t=eT(),Object.fromEntries(e)}(),eh(t,function(){var t,i,r,o,n;return t=ex(),eT(),(em++,r=ed,"1-0"===e.substr(ed,3)?(o="1-0",ed+=3):(o=s,0===em&&ey(er)),o===s&&("0-1"===e.substr(ed,3)?(o="0-1",ed+=3):(o=s,0===em&&ey(eo)),o===s&&(e.substr(ed,7)===d?(o=d,ed+=7):(o=s,0===em&&ey(en)),o===s&&(42===e.charCodeAt(ed)?(o="*",ed++):(o=s,0===em&&ey(es))))),o!==s)?(eT(),(n=eA())===s&&(n=null),r={result:o,comment:n}):(ed=r,r=s),em--,r===s&&(o=s,0===em&&ey(ei)),(i=r)===s&&(i=null),eT(),{root:t,marker:i}}())}function eS(){var t,i,r,o,n,a,l;return(em++,t=ed,eT(),91===e.charCodeAt(ed)?(i="[",ed++):(i=s,0===em&&ey(S)),i!==s&&(eT(),(r=function(){var t,i,r;if(em++,t=ed,i=[],r=e.charAt(ed),f.test(r)?ed++:(r=s,0===em&&ey(A)),r!==s)for(;r!==s;)i.push(r),r=e.charAt(ed),f.test(r)?ed++:(r=s,0===em&&ey(A));else i=s;return t=i!==s?e.substring(t,ed):i,em--,t===s&&(i=s,0===em&&ey(M)),t}())!==s&&(eT(),34===e.charCodeAt(ed)?(o='"',ed++):(o=s,0===em&&ey(x)),o!==s&&(n=function(){var t,i,r;for(em++,t=ed,i=[],r=e.charAt(ed),p.test(r)?ed++:(r=s,0===em&&ey(T));r!==s;)i.push(r),r=e.charAt(ed),p.test(r)?ed++:(r=s,0===em&&ey(T));return t=e.substring(t,ed),em--,i=s,0===em&&ey(P),t}(),34===e.charCodeAt(ed)?(a='"',ed++):(a=s,0===em&&ey(x)),a!==s&&(eT(),93===e.charCodeAt(ed)?(l="]",ed++):(l=s,0===em&&ey(E)),l!==s)))))?t=[r,n]:(ed=t,t=s),em--,t===s&&0===em&&ey(C),t}function ex(){var e,t,i;for((e=eA())===s&&(e=null),t=[],i=eE();i!==s;)t.push(i),i=eE();return ec(e,t)}function eE(){var t,i,r,o,n,a,l,h;if(t=ed,eT(),function(){var t,i,r,o,n,a;for(em++,t=ed,i=[],r=e.charAt(ed),g.test(r)?ed++:(r=s,0===em&&ey(L));r!==s;)i.push(r),r=e.charAt(ed),g.test(r)?ed++:(r=s,0===em&&ey(L));if(46===e.charCodeAt(ed)?(r=".",ed++):(r=s,0===em&&ey(I)),r!==s){for(o=eT(),n=[],a=e.charAt(ed),m.test(a)?ed++:(a=s,0===em&&ey(R));a!==s;)n.push(a),a=e.charAt(ed),m.test(a)?ed++:(a=s,0===em&&ey(R));t=i=[i,r,o,n]}else ed=t,t=s;em--,t===s&&(i=s,0===em&&ey(O))}(),eT(),(i=function(){var t,i,r,o,n,a;if(em++,t=ed,i=ed,e.substr(ed,5)===c?(r=c,ed+=5):(r=s,0===em&&ey(q)),r===s&&("O-O"===e.substr(ed,3)?(r="O-O",ed+=3):(r=s,0===em&&ey(j)),r===s&&(e.substr(ed,5)===u?(r=u,ed+=5):(r=s,0===em&&ey(K)),r===s))&&("0-0"===e.substr(ed,3)?(r="0-0",ed+=3):(r=s,0===em&&ey($)),r===s))if(r=ed,o=e.charAt(ed),f.test(o)?ed++:(o=s,0===em&&ey(A)),o!==s){if(n=[],a=e.charAt(ed),b.test(a)?ed++:(a=s,0===em&&ey(D)),a!==s)for(;a!==s;)n.push(a),a=e.charAt(ed),b.test(a)?ed++:(a=s,0===em&&ey(D));else n=s;n!==s?r=o=[o,n]:(ed=r,r=s)}else ed=r,r=s;return r!==s?(o=e.charAt(ed),v.test(o)?ed++:(o=s,0===em&&ey(F)),o===s&&(o=null),i=r=[r,o]):(ed=i,i=s),t=i!==s?e.substring(t,ed):i,em--,t===s&&(i=s,0===em&&ey(N)),t}())!==s){for((r=function(){var t,i,r;for(em++,t=ed,i=[],r=e.charAt(ed),_.test(r)?ed++:(r=s,0===em&&ey(U));r!==s;)i.push(r),i.length>=2?r=s:(r=e.charAt(ed),_.test(r)?ed++:(r=s,0===em&&ey(U)));return i.length<1?(ed=t,t=s):t=i,em--,t===s&&(i=s,0===em&&ey(B)),t}())===s&&(r=null),o=[],n=eM();n!==s;)o.push(n),n=eM();for(n=eT(),(a=eA())===s&&(a=null),l=[],h=eP();h!==s;)l.push(h),h=eP();t=eu(i,r,o,a,l)}else ed=t,t=s;return t}function eM(){var t,i,r,o,n;if(em++,t=ed,eT(),36===e.charCodeAt(ed)?(i="$",ed++):(i=s,0===em&&ey(H)),i!==s){if(r=ed,o=[],n=e.charAt(ed),g.test(n)?ed++:(n=s,0===em&&ey(L)),n!==s)for(;n!==s;)o.push(n),n=e.charAt(ed),g.test(n)?ed++:(n=s,0===em&&ey(L));else o=s;(r=o!==s?e.substring(r,ed):o)!==s?t=r:(ed=t,t=s)}else ed=t,t=s;return em--,t===s&&0===em&&ey(W),t}function eA(){var t;return(t=function(){var t,i,r,o,n;if(em++,t=ed,123===e.charCodeAt(ed)?(i="{",ed++):(i=s,0===em&&ey(Q)),i!==s){for(r=ed,o=[],n=e.charAt(ed),w.test(n)?ed++:(n=s,0===em&&ey(G));n!==s;)o.push(n),n=e.charAt(ed),w.test(n)?ed++:(n=s,0===em&&ey(G));(r=e.substring(r,ed),125===e.charCodeAt(ed)?(o="}",ed++):(o=s,0===em&&ey(V)),o!==s)?t=r.replace(/[\r\n]+/g," "):(ed=t,t=s)}else ed=t,t=s;return em--,t===s&&(i=s,0===em&&ey(z)),t}())===s&&(t=function(){var t,i,r,o,n;if(em++,t=ed,59===e.charCodeAt(ed)?(i=";",ed++):(i=s,0===em&&ey(X)),i!==s){for(r=ed,o=[],n=e.charAt(ed),k.test(n)?ed++:(n=s,0===em&&ey(Y));n!==s;)o.push(n),n=e.charAt(ed),k.test(n)?ed++:(n=s,0===em&&ey(Y));t=(r=e.substring(r,ed)).trim()}else ed=t,t=s;return em--,t===s&&(i=s,0===em&&ey(Z)),t}()),t}function eP(){var t,i,r,o;return(em++,t=ed,eT(),40===e.charCodeAt(ed)?(i="(",ed++):(i=s,0===em&&ey(ee)),i!==s&&(r=ex())!==s&&(eT(),41===e.charCodeAt(ed)?(o=")",ed++):(o=s,0===em&&ey(et)),o!==s))?t=r:(ed=t,t=s),em--,t===s&&0===em&&ey(J),t}function eT(){var t,i;for(em++,t=[],i=e.charAt(ed),y.test(i)?ed++:(i=s,0===em&&ey(el));i!==s;)t.push(i),i=e.charAt(ed),y.test(i)?ed++:(i=s,0===em&&ey(el));return em--,i=s,0===em&&ey(ea),t}if(n=h(),t.peg$library)return{peg$result:n,peg$currPos:ed,peg$FAILED:s,peg$maxFailExpected:eg,peg$maxFailPos:ep};if(n!==s&&ed===e.length)return n;throw n!==s&&ed<e.length&&ey({type:"end"}),i=eg,r=ep<e.length?e.charAt(ep):null,o=ep<e.length?ek(ep,ep+1):ek(ep,ep),new e4(e4.buildMessage(i,r),i,r,o)}(e);this.reset();let o=r.headers,n="";for(let e in o)"fen"===e.toLowerCase()&&(n=o[e]),this.header(e,o[e]);if(t){if("1"===o.SetUp){if(!("FEN"in o))throw Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}}else n&&this.load(n,{preserveHeaders:!0});let s=r.root;for(;s;){if(s.move){let e=this._moveFromSan(s.move,t);if(null==e)throw Error(`Invalid move in PGN: ${s.move}`);this._makeMove(e),this._incPositionCount()}void 0!==s.comment&&(this._comments[this.fen()]=s.comment),s=s.variations[0]}let a=r.result;a&&Object.keys(this._header).length&&this._header.Result!==a&&this.setHeader("Result",a)}_moveToSan(e,t){let i="";if(e.flags&th.KSIDE_CASTLE)i="O-O";else if(e.flags&th.QSIDE_CASTLE)i="O-O-O";else{if(e.flags&th.NULL_MOVE)return"--";if("p"!==e.piece){let r=function(e,t){let i=e.from,r=e.to,o=e.piece,n=0,s=0,a=0;for(let e=0,l=t.length;e<l;e++){let l=t[e].from,h=t[e].to;o===t[e].piece&&i!==l&&r===h&&(n++,i>>4==l>>4&&s++,(15&i)==(15&l)&&a++)}if(n>0)if(s>0&&a>0)return tC(i);else if(a>0)return tC(i).charAt(1);else return tC(i).charAt(0);return""}(e,t);i+=e.piece.toUpperCase()+r}e.flags&(th.CAPTURE|th.EP_CAPTURE)&&("p"===e.piece&&(i+=tC(e.from)[0]),i+="x"),i+=tC(e.to),e.promotion&&(i+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?i+="#":i+="+"),this._undoMove(),i}_moveFromSan(e,t=!1){let i,r,o,n,s,a=tM(e);if(t||("0-0"===a?a="O-O":"0-0-0"===a&&(a="O-O-O")),"--"==a)return{color:this._turn,from:0,to:0,piece:"k",flags:th.NULL_MOVE};let l=tE(a),h=this._moves({legal:!0,piece:l});for(let e=0,t=h.length;e<t;e++)if(a===tM(this._moveToSan(h[e],h)))return h[e];if(t)return null;let c=!1;if((r=a.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/))?(i=r[1],o=r[2],n=r[3],s=r[4],1==o.length&&(c=!0)):(r=a.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/))&&(i=r[1],o=r[2],n=r[3],s=r[4],1==o.length&&(c=!0)),l=tE(a),h=this._moves({legal:!0,piece:i||l}),!n)return null;for(let e=0,t=h.length;e<t;e++)if(o){if((!i||i.toLowerCase()==h[e].piece)&&td[o]==h[e].from&&td[n]==h[e].to&&(!s||s.toLowerCase()==h[e].promotion))return h[e];else if(c){let t=tC(h[e].from);if((!i||i.toLowerCase()==h[e].piece)&&td[n]==h[e].to&&(o==t[0]||o==t[1])&&(!s||s.toLowerCase()==h[e].promotion))return h[e]}}else if(a===tM(this._moveToSan(h[e],h)).replace("x",""))return h[e];return null}ascii(){let e="   +------------------------+\n";for(let t=td.a8;t<=td.h1;t++){if(0==(15&t)&&(e+=" "+"87654321"[t>>4]+" |"),this._board[t]){let i=this._board[t].type;e+=" "+("w"===this._board[t].color?i.toUpperCase():i.toLowerCase())+" "}else e+=" . ";t+1&136&&(e+="|\n",t+=8)}return e+"   +------------------------+\n     a  b  c  d  e  f  g  h"}perft(e){let t=this._moves({legal:!1}),i=0,r=this._turn;for(let o=0,n=t.length;o<n;o++)this._makeMove(t[o]),!this._isKingAttacked(r)&&(e-1>0?i+=this.perft(e-1):i++),this._undoMove();return i}setTurn(e){return this._turn!=e&&(this.move("--"),!0)}turn(){return this._turn}board(){let e=[],t=[];for(let i=td.a8;i<=td.h1;i++)null==this._board[i]?t.push(null):t.push({square:tC(i),type:this._board[i].type,color:this._board[i].color}),i+1&136&&(e.push(t),t=[],i+=8);return e}squareColor(e){if(e in td){let t=td[e];return((t>>4)+(15&t))%2==0?"light":"dark"}return null}history({verbose:e=!1}={}){let t=[],i=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){let r=t.pop();if(!r)break;e?i.push(new ta(this,r)):i.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return i}_getPositionCount(e){return this._positionCount.get(e)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(e){let t=this._positionCount.get(e)??0;1===t?this._positionCount.delete(e):this._positionCount.set(e,t-1)}_pruneComments(){let e=[],t={},i=e=>{e in this._comments&&(t[e]=this._comments[e])};for(;this._history.length>0;)e.push(this._undoMove());for(i(this.fen());;){let t=e.pop();if(!t)break;this._makeMove(t),i(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{let t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(let i of["k","q"])void 0!==t[i]&&(t[i]?this._castling[e]|=t_[i]:this._castling[e]&=~t_[i]);this._updateCastlingRights();let i=this.getCastlingRights(e);return(void 0===t.k||t.k===i.k)&&(void 0===t.q||t.q===i.q)}getCastlingRights(e){return{k:(this._castling[e]&t_.k)!=0,q:(this._castling[e]&t_.q)!=0}}moveNumber(){return this._moveNumber}}var tP=e.i(22364),tT=e.i(26412),tO=e.i(69881),tL=e.i(11726),tI=e.i(65286),tR=e.i(35607),tN=e.i(48474),tq=e.i(43326),tj=e.i(42097),tK=e.i(32569),t$=e.i(49546),tD=e.i(80203),tF=e.i(29227),tB=e.i(47069),tU=e.i(9544),tW=e.i(46643),tH=e.i(43966);let tz={0:{description:"Very easy",UciEloRange:[400,800],skillLevelRange:[0,2],moveTimeRange:[200,500],depthRange:[1,1],limitStrength:!0},1:{description:"Easy",UciEloRange:[800,1200],skillLevelRange:[3,6],moveTimeRange:[500,1e3],depthRange:[2,4],limitStrength:!0},2:{description:"Medium",UciEloRange:[1200,2e3],skillLevelRange:[7,12],moveTimeRange:[1e3,2e3],depthRange:[5,9],limitStrength:!0},3:{description:"Hard",UciEloRange:null,skillLevelRange:[13,18],moveTimeRange:[2e3,6e3],depthRange:[10,19],limitStrength:!1},4:{description:"Very hard",UciEloRange:null,skillLevelRange:[19,20],moveTimeRange:[1e4,2e4],depthRange:[20,32],limitStrength:!1}},tQ=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;var tG=e.i(68120);let tV=(0,s.createTheme)({colorSchemes:{dark:!0}});class tZ{constructor(){this.wasmSupported="object"==typeof WebAssembly&&WebAssembly.validate(Uint8Array.of(0,97,115,109,1,0,0,0)),this.worker=new Worker(this.wasmSupported?"/online-games-portal/js/stockfish.wasm.js":"/online-games-portal/js/stockfish.js"),this.onMessage=null,this.initialized=!1,this.uciElo=100,this.skillLevel=0,this.depth=1,this.moveTime=500,this.limitStrength=!0,this.worker.onmessage=e=>{this.onMessage&&this.onMessage(e.data)}}init(){this.sendCommand("uci"),this.sendCommand("isready"),this.initialized=!0}setDifficulty(e){let t=function(e=1){return{uciElo:tz[e].UciEloRange?tQ(tz[e].UciEloRange[0],tz[e].UciEloRange[1]):null,skillLevel:tQ(tz[e].skillLevelRange[0],tz[e].skillLevelRange[1]),moveTime:tQ(tz[e].moveTimeRange[0],tz[e].moveTimeRange[1]),depth:tQ(tz[e].depthRange[0],tz[e].depthRange[1]),limitStrength:tz[e].limitStrength}}(e);this.uciElo=t.uciElo,this.skillLevel=t.skillLevel,this.depth=t.depth,this.moveTime=t.moveTime,this.limitStrength=t.limitStrength,this.sendCommand(`setoption name Skill Level value ${this.skillLevel}`),this.sendCommand(`setoption name UCI_LimitStrength value ${this.limitStrength}`),this.uciElo&&this.sendCommand(`setoption name UCI_Elo value ${this.uciElo}`)}sendCommand(e){this.worker.postMessage(e)}setPosition(e,t=[]){let i=`position fen ${e}`;t.length>0&&(i=`position fen ${e} moves ${t.join(" ")}`),this.sendCommand(i)}getBestMove(){this.sendCommand("stop"),this.skillLevel<=3?this.sendCommand(`go depth ${this.depth}`):this.skillLevel<=8?this.sendCommand(`go depth ${this.depth} movetime ${this.moveTime}`):this.sendCommand(`go movetime ${this.moveTime}`)}stop(){this.sendCommand("stop")}destroy(){this.worker.terminate()}}function tX(){let e=(0,o.useRouter)(),{currentUser:t,setCurrentUser:r}=(0,a.useContext)(tF.CurrentUserContext),{socket:s}=(0,a.useContext)(tB.SocketContext),d=(0,o.useSearchParams)().get("id"),[m,w]=(0,a.useState)(!1),[E,T]=(0,a.useState)(!0),[R,N]=(0,a.useState)(!1),[q,j]=(0,a.useState)(new tA),[U,W]=(0,a.useState)({}),[Q,V]=(0,a.useState)(""),[X,Y]=(0,a.useState)(null),[eo,eh]=(0,a.useState)("white"),[ec,ef]=(0,a.useState)([]),[ep,eg]=(0,a.useState)(),[eE,eT]=(0,a.useState)(null),[eO,eL]=(0,a.useState)(!1),[eR,eN]=(0,a.useState)(null),[e4,e5]=a.default.useState(!1),e7=(e,t)=>{"clickaway"!==t&&e5(!1)},e9=(0,a.useRef)(null),te=(0,a.useRef)(null),tt=(0,a.useRef)(!1),ti=U.players?.black==="Computer";(0,a.useEffect)(()=>{if(ti&&!eE){let e=new tZ;e.init(),e.onMessage=e=>{if(e.startsWith("bestmove")){let t=e.split(" ");t[1]&&"(none)"!==t[1]&&eN(t[1]),eL(!1)}},e.setDifficulty(t.computerStrength||0),eT(e)}return()=>{eE&&eE.destroy()}},[ti]),(0,a.useEffect)(()=>{eO&&!q.isGameOver()&&(!eE||!ti||q.isGameOver()||tr||null===X||(eE.setPosition(q.fen()),.2>Math.random()&&eE.setDifficulty(t.computerStrength||0),eE.getBestMove()))},[q,eE,ti,eO]),(0,a.useEffect)(()=>{s&&s.emit("list of games",{})},[]),(0,a.useEffect)(()=>{U.players&&t.login&&(U.players.white===t.login?Y("white"):U.players.black===t.login&&Y("black"))},[U,t]),(0,a.useEffect)(()=>{eh("w"===q.turn()?"white":"black"),ti&&"b"===q.turn()&&eL(!0)},[q]);let tr=X===eo,to=U&&"ongoing"===U.status&&U.players&&null!==U.players.white&&null!==U.players.black,tn=(0,a.useCallback)(()=>{let e=new Map;for(let t=0;t<64;t++){let i="abcdefgh"[t%8]+(Math.floor(t/8)+1),r=q.moves({square:i,verbose:!0});r.length>0&&e.set(i,r.map(e=>e.to))}return e},[q]),ts=(0,a.useCallback)(()=>{let e="",i=!1;return q.isCheckmate()?(e=`${(0,tH.default)("checkmate",t.language)}. ${"w"===q.turn()?(0,tH.default)("blackWinsGame",t.language):(0,tH.default)("whiteWinsGame",t.language)}`,i=!0):q.isStalemate()?(e=`${(0,tH.default)("stalemate",t.language)}. ${(0,tH.default)("draw",t.language)}`,i=!0):q.isInsufficientMaterial()?(e=`${(0,tH.default)("insufficientMaterial",t.language)}. ${(0,tH.default)("draw",t.language)}`,i=!0):q.isThreefoldRepetition()?(e=`${(0,tH.default)("threefoldRepetition",t.language)}. ${(0,tH.default)("draw",t.language)}`,i=!0):q.isDraw()?(e=`${(0,tH.default)("draw",t.language)} ${(0,tH.default)("by50MoveRule",t.language)}`,i=!0):e=q.isCheck()?`${"w"===q.turn()?(0,tH.default)("whiteIsInCheck",t.language):(0,tH.default)("blackIsInCheck",t.language)}!`:`${"w"===q.turn()?(0,tH.default)("whitesTurn",t.language):(0,tH.default)("blacksTurn",t.language)}`,(i||!eO)&&eE&&ti&&eE.stop(),{gameOver:i,status:e,isCheck:q.isCheck(),isCheckmate:q.isCheckmate(),isDraw:q.isDraw()}},[q]),ta=(0,a.useCallback)((e,i)=>{if(!tr)return!1;try{let r=q.get(e);if(r&&("white"===X&&"w"!==r.color||"black"===X&&"b"!==r.color))return!1;if(r&&"p"===r.type&&("w"===r.color&&"8"===i[1]||"b"===r.color&&"1"===i[1])?q.move({from:e,to:i,promotion:"q"}):q.move({from:e,to:i})){ef([e,i]);let r=new tA;return r.loadPgn(q.pgn()),j(r),V(r.pgn()),s.emit("update game",{name:"chess",gameId:d,login:t.login,token:t.token,move:{pgn:r.pgn()}}),!0}return!1}catch(e){return console.error("Invalid move:",e),!1}},[q,s,d,t,tr,to,X]);return((0,a.useEffect)(()=>{if(eR&&!tr&&null!==X)try{let e=q.move(eR);if(e){ef([e.from,e.to]);let i=new tA;i.loadPgn(q.pgn()),j(i),V(i.pgn()),s.emit("update game",{name:"chess",gameId:d,login:t.login,token:t.token,move:{pgn:i.pgn()}}),eL(!1),eN(null)}}catch(e){console.error("Computer move error:",e)}},[eR,eO]),(0,a.useEffect)(()=>(e9.current&&!tt.current&&(tt.current=!0,ts(),te.current=function(e,t){let i,r={pieces:es(er),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,touchIgnoreRadius:1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,additionalPremoveRequirements:e=>!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnMovablePieceClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10},paleWhite:{key:"pwhite",color:"white",opacity:.6,lineWidth:10}},prevSvgHash:""},hold:{start(){i=performance.now()},cancel(){i=void 0},stop(){if(!i)return 0;let e=performance.now()-i;return i=void 0,e}}};function o(){var t;let i,o="dom"in r?r.dom.unbind:void 0,n=function(e,t){let i,r,o,n,s,a;for(let i of(e.innerHTML="",e.classList.add("cg-wrap"),l))e.classList.toggle("orientation-"+i,t.orientation===i);e.classList.toggle("manipulable",!t.viewOnly);let u=A("cg-container");e.appendChild(u);let d=A("cg-board");if(u.appendChild(d),t.drawable.visible&&([i,r]=["cg-shapes-below","cg-shapes"].map(e=>eQ(e,!0)),[o,n]=["cg-custom-below","cg-custom-svgs"].map(e=>eQ(e,!1)),s=A("cg-auto-pieces"),u.appendChild(i),u.appendChild(o),u.appendChild(r),u.appendChild(n),u.appendChild(s)),t.coordinates){let e="black"===t.orientation?" black":"",i="left"===t.ranksPosition?" left":"";if(t.coordinatesOnSquares){let r="white"===t.orientation?e=>e+1:e=>8-e;h.forEach((t,o)=>u.appendChild(eG(c.map(e=>t+e),"squares rank"+r(o)+e+i,o%2==0?"black":"white")))}else u.appendChild(eG(c,"ranks"+e+i,"right"===t.ranksPosition==("white"===t.orientation)?"white":"black")),u.appendChild(eG(h,"files"+e,v(t.orientation)))}return t.draggable.enabled&&t.draggable.showGhost&&(S(a=A("piece","ghost"),!1),u.appendChild(a)),{board:d,container:u,wrap:e,ghost:a,shapes:r,shapesBelow:i,custom:n,customBelow:o,autoPieces:s}}(e,r),s=b(()=>n.board.getBoundingClientRect()),a=e=>{var t;!function(e){let t,i,r,o,n,s,a,l,h,c,u="white"===e.orientation,d=k(e.dom.bounds()),f=e.dom.elements.board,g=e.pieces,m=e.animation.current,b=m?m.plan.anims:new Map,v=m?m.plan.fadings:new Map,_=e.draggable.current,w=function(e){let t=new Map;if(e.lastMove&&e.highlight.lastMove)for(let[i,r]of e.lastMove.entries())e3(t,1===i?e6(e,r):r,"last-move");if(e.check&&e.highlight.check&&e3(t,e.check,"check"),e.selected&&(e3(t,e.selected,"selected"),e.movable.showDests)){for(let i of e.movable.dests?.get(e.selected)??[])e3(t,i,"move-dest"+(e.pieces.has(i)?" oc":""));for(let i of e.premovable.customDests?.get(e.selected)??e.premovable.dests??[])e3(t,i,"premove-dest"+(e.pieces.has(i)?" oc":""))}let i=e.premovable.current;if(i)for(let e of i)e3(t,e,"current-premove");else e.predroppable.current&&e3(t,e.predroppable.current.key,"current-premove");let r=e.exploding;if(r)for(let e of r.keys)e3(t,e,"exploding"+r.stage);return e.highlight.custom&&e.highlight.custom.forEach((e,i)=>{e3(t,i,e)}),t}(e),C=new Set,S=new Set,x=new Map,E=new Map;for(i=f.firstChild;i;){if(t=i.cgKey,eY(i))if(r=g.get(t),n=b.get(t),s=v.get(t),o=i.cgPiece,i.cgDragging&&(!_||_.orig!==t)&&(i.classList.remove("dragging"),y(i,d(p(t),u)),i.cgDragging=!1),!s&&i.cgFading&&(i.cgFading=!1,i.classList.remove("fading")),r){if(n&&i.cgAnimating&&o===e2(r)){let e=p(t);e[0]+=n[2],e[1]+=n[3],i.classList.add("anim"),y(i,d(e,u))}else i.cgAnimating&&(i.cgAnimating=!1,i.classList.remove("anim"),y(i,d(p(t),u)),e.addPieceZIndex&&(i.style.zIndex=e1(p(t),u)));o!==e2(r)||s&&i.cgFading?s&&o===e2(s)?(i.classList.add("fading"),i.cgFading=!0):e8(x,o,i):C.add(t)}else e8(x,o,i);else if(eJ(i)){let e=i.className;w.get(t)===e?S.add(t):e8(E,e,i)}i=i.nextSibling}for(let[e,t]of w)if(!S.has(e)){c=(h=E.get(t))&&h.pop();let i=d(p(e),u);if(c)c.cgKey=e,y(c,i);else{let r=A("square",t);r.cgKey=e,y(r,i),f.insertBefore(r,f.firstChild)}}for(let[t,i]of g)if(n=b.get(t),!C.has(t))if(l=(a=x.get(e2(i)))&&a.pop()){l.cgKey=t,l.cgFading&&(l.classList.remove("fading"),l.cgFading=!1);let i=p(t);e.addPieceZIndex&&(l.style.zIndex=e1(i,u)),n&&(l.cgAnimating=!0,l.classList.add("anim"),i[0]+=n[2],i[1]+=n[3]),y(l,d(i,u))}else{let r=e2(i),o=A("piece",r),s=p(t);o.cgPiece=r,o.cgKey=t,n&&(o.cgAnimating=!0,s[0]+=n[2],s[1]+=n[3]),y(o,d(s,u)),e.addPieceZIndex&&(o.style.zIndex=e1(s,u)),f.appendChild(o)}for(let t of x.values())e0(e,t);for(let t of E.values())e0(e,t)}(d),n.autoPieces&&(t=n.autoPieces,function(e,t,i){let r=new Map,o=[];for(let t of e)r.set(t.hash,!1);let n=t.firstElementChild,s;for(;n;)s=n.getAttribute("cgHash"),r.has(s)?r.set(s,!0):o.push(n),n=n.nextElementSibling;for(let e of o)t.removeChild(e);for(let o of e)r.get(o.hash)||t.appendChild(i(o))}(d.drawable.autoShapes.filter(e=>e.piece).map(e=>{let t;return{shape:e,hash:[(t=e).orig,t.piece?.role,t.piece?.color,t.piece?.scale].join(","),current:!1,pendingErase:!1}}),t,e=>(function(e,{shape:t,hash:i},r){let o=t.orig,n=t.piece?.role,s=t.piece?.color,a=t.piece?.scale,l=A("piece",`${n} ${s}`);return l.setAttribute("cgHash",i),l.cgKey=o,l.cgScale=a,C(l,k(r)(p(o),"white"===e.orientation),a),l})(d,e,d.dom.bounds()))),!e&&n.shapes&&function(e,t){let i=e.drawable,r=i.current,o=r&&r.mouseSq?r:void 0,n=new Map,s=e.dom.bounds(),a=i.autoShapes.filter(e=>!e.piece);for(let t of i.shapes.concat(a).concat(o?[o]:[])){if(!t.dest)continue;let i=n.get(t.dest)??new Set,r=eU(eI(p(t.orig),e.orientation),s),o=eU(eI(p(t.dest),e.orientation),s);i.add(eW(eH(r,o))),n.set(t.dest,i)}let l=[],h=o?i.shapes.findIndex(e=>ew(e,o)&&e.brush===o.brush):-1;for(let[e,t]of i.shapes.concat(a).entries()){let i=-1!==h&&h===e;l.push({shape:t,current:!1,pendingErase:i,hash:eP(t,eq(t.dest,n),!1,s,i,eK(t.dest,n))})}o&&-1===h&&l.push({shape:o,current:!0,hash:eP(o,eq(o.dest,n),!0,s,!1,eK(o.dest,n)),pendingErase:!1});let c=l.map(e=>e.hash).join(";");c!==e.drawable.prevSvgHash&&(e.drawable.prevSvgHash=c,function(e,t,i){for(let r of[i.shapes,i.shapesBelow]){let o=r.querySelector("defs"),n=t.filter(e=>r===i.shapesBelow==!!e.shape.below),s=new Map;for(let t of n.filter(e=>e.shape.dest&&e.shape.brush)){let i=eD(e.brushes[t.shape.brush],t.shape.modifiers),{key:r,color:o}=eF(t.shape);r&&o&&s.set(r,{key:r,color:o,opacity:1,lineWidth:1}),s.set(i.key,i)}let a=new Set,l=o.firstElementChild;for(;l;)a.add(l.getAttribute("cgKey")),l=l.nextElementSibling;for(let[e,t]of s.entries())a.has(e)||o.appendChild(function(e){let t=e$(ej("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(e$(ej("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}(t))}}(i,l,t),function(e,t,i){for(let[r,o]of[[t.shapes,t.custom],[t.shapesBelow,t.customBelow]]){let[n,s]=[r,o].map(e=>e.querySelector("g")),a=e.filter(e=>r===t.shapesBelow==!!e.shape.below),l=new Map;for(let e of a)l.set(e.hash,!1);for(let e of[n,s]){let t=[],i=e.firstElementChild,r;for(;i;)r=i.getAttribute("cgHash"),l.has(r)?l.set(r,!0):t.push(i),i=i.nextElementSibling;for(let i of t)e.removeChild(i)}for(let e of a.filter(e=>!l.get(e.hash)))for(let t of i(e))t.isCustom?s.appendChild(t.el):n.appendChild(t.el)}}(l,t,t=>(function(e,{shape:t,current:i,pendingErase:r,hash:o},n,s,a){var l,h,c,u,d,f,g,m,b,v,_;let w=eU(eI(p(t.orig),e.orientation),a),k=t.dest?eU(eI(p(t.dest),e.orientation),a):w,y=t.brush&&eD(n[t.brush],t.modifiers),C=s.get(t.dest),S=[];if(y){let e,f,p=e$(ej("g"),{cgHash:o});S.push({el:p}),w[0]!==k[0]||w[1]!==k[1]?p.appendChild(function(e,t,i,r,o,n,s){var a,l;let h;function c(a){let l,h,c=(n&&!o?20:10)/64,u=r[0]-i[0],d=Math.atan2(r[1]-i[1],u),f=Math.cos(d)*c,p=Math.sin(d)*c,g=eF(e);return e$(ej("line"),{stroke:a?g.color:t.color,"stroke-width":(l=t,h=o,(l.lineWidth||10)*(h?.85:1)/64*(a?1.14:1)),"stroke-linecap":"round","marker-end":`url(#arrowhead-${a?g.key:t.key})`,opacity:e.modifiers?.hilite&&!s?1:eB(t,o,s),x1:i[0],y1:i[1],x2:r[0]-f,y2:r[1]-p})}if(!e.modifiers?.hilite)return c(!1);let u=e$(ej("g"),{opacity:t.opacity}),d=e$(ej("g"),{filter:"url(#cg-filter-blur)"});return d.appendChild((a=i,l=r,h={from:[Math.floor(Math.min(a[0],l[0])),Math.floor(Math.min(a[1],l[1]))],to:[Math.ceil(Math.max(a[0],l[0])),Math.ceil(Math.max(a[1],l[1]))]},e$(ej("rect"),{x:h.from[0],y:h.from[1],width:h.to[0]-h.from[0],height:h.to[1]-h.from[1],fill:"none",stroke:"none"}))),d.appendChild(c(!0)),u.appendChild(d),u.appendChild(c(!1)),u}(t,y,w,k,i,eq(t.dest,s),r)):p.appendChild((l=n[t.brush],h=w,c=i,u=a,d=r,e=[3/64,4/64],f=(u.width+u.height)/(4*Math.max(u.width,u.height)),e$(ej("circle"),{stroke:l.color,"stroke-width":e[+!c],fill:"none",opacity:eB(l,c,d),cx:h[0],cy:h[1],r:f-e[1]/2})))}if(t.label){let e,i,r,s,a,l=t.label;l.fill??(l.fill=t.brush&&n[t.brush].color);let h=t.brush?void 0:"tr";S.push({el:(f=l,g=o,m=w,b=k,v=C,_=h,e=.4*.75**f.text.length,i=ez(m,b,v),r=.4*("tr"===_),(s=e$(ej("g"),{transform:`translate(${i[0]+r},${i[1]-r})`,cgHash:g})).appendChild(e$(ej("circle"),{r:.2,"fill-opacity":_?1:.8,"stroke-opacity":_?1:.7,"stroke-width":.03,fill:f.fill??"#666",stroke:"white"})),(a=e$(ej("text"),{"font-size":e,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**f.text.length})).innerHTML=f.text,s.appendChild(a),s),isCustom:!0})}if(t.customSvg){let e=t.customSvg.center??"orig",[i,r]="label"===e?ez(w,k,C).map(e=>e-.5):"dest"===e?k:w,n=e$(ej("g"),{transform:`translate(${i},${r})`,cgHash:o});n.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,S.push({el:n,isCustom:!0})}return S})(e,t,i.brushes,n,s)))}(d,n)},u=()=>{eX(d);let e="white"===d.orientation,t=k(d.dom.bounds()),i=d.dom.elements.board.firstChild;for(;i;)(eY(i)&&!i.cgAnimating||eJ(i))&&y(i,t(p(i.cgKey),e)),i=i.nextSibling;n.autoPieces&&function(e){let t="white"===e.orientation,i=k(e.dom.bounds()),r=e.dom.elements.autoPieces?.firstChild;for(;r;)C(r,i(p(r.cgKey),t),r.cgScale),r=r.nextSibling}(d)},d=r;return d.dom={elements:n,bounds:s,redraw:(t=a,i=!1,()=>{i||(i=!0,requestAnimationFrame(()=>{t(),i=!1}))}),redrawNow:a,unbind:o},d.drawable.prevSvgHash="",eX(d),a(!1),!function(e,t){let i,r=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&r.addEventListener("contextmenu",e=>e.preventDefault()),e.viewOnly)return;let o=(i=e,e=>{i.draggable.current?ex(i):i.drawable.current?e_(i):e.shiftKey||M(e)?i.drawable.enabled&&function(e,t){var i;if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?G(e):ee(e);let r=x(t),o=ei(r,"white"===e.orientation,e.dom.bounds());o&&(e.drawable.current={orig:o,pos:r,brush:em[+!!(((i=t).shiftKey||i.ctrlKey)&&M(i))+2*!!(i.altKey||i.metaKey||i.getModifierState?.("AltGraph"))],snapToValidMove:e.drawable.defaultSnapToValidMove},function e(t){requestAnimationFrame(()=>{let i=t.drawable.current;if(i){let r=ei(i.pos,"white"===t.orientation,t.dom.bounds());r||(i.snapToValidMove=!1);let o=i.snapToValidMove?function(e,t,i,r){let o=p(e),n=g.filter(e=>{let t,i,r,n;return o[0]===e[0]&&o[1]===e[1]||(t=o[0],L(t,i=o[1],r=e[0],n=e[1])||I(t,i,r,n))||O(o[0],o[1],e[0],e[1])}),s=n.map(e=>P(f(e),i,r)).map(e=>_(t,e)),[,a]=s.reduce((e,t,i)=>e[0]<t?e:[t,i],[s[0],0]);return f(n[a])}(i.orig,i.pos,"white"===t.orientation,t.dom.bounds()):r;o!==i.mouseSq&&(i.mouseSq=o,i.dest=o!==i.orig?o:void 0,t.dom.redrawNow()),e(t)}})}(e))}(i,e):i.viewOnly||(i.dropmode.active?function(e,t){if(!e.dropmode.active)return;$(e),D(e);let i=e.dropmode.piece;if(i){e.pieces.set("a0",i);let r=x(t),o=r&&ei(r,"white"===e.orientation,e.dom.bounds());o&&H(e,"a0",o)}e.dom.redraw()}(i,e):function(e,t){let i;if(!(e.trustAllEvents||t.isTrusted)||void 0!==t.buttons&&t.buttons>1||t.touches&&t.touches.length>1)return;let r=e.dom.bounds(),o=x(t),n=ei(o,"white"===e.orientation,r);if(!n)return;let s=e.pieces.get(n),a=e.selected;if(!a&&e.drawable.enabled&&(e.drawable.eraseOnMovablePieceClick||!s||s.color!==e.turnColor)&&e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),ek(e.drawable)),!1!==t.cancelable&&(!t.touches||e.blockTouchScroll||s||a||function(e,t){let i="white"===e.orientation,r=e.dom.bounds(),o=2*Math.pow(e.touchIgnoreRadius*r.width/16,2);for(let n of e.pieces.keys())if(_(P(n,i,r),t)<=o)return!0;return!1}(e,o)))t.preventDefault();else if(t.touches)return;let l=!!e.premovable.current,h=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Z(e,e.selected,n)?eu(e=>z(e,n),e):z(e,n);let c=e.selected===n,u=eM(e,n);if(s&&u&&c&&(i=e.pieces.get(n))&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===i.color&&(e.turnColor===i.color||e.premovable.enabled))){e.draggable.current={orig:n,piece:s,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:a,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");let i=e.dom.elements.ghost;i&&(i.className=`ghost ${s.color} ${s.role}`,y(i,k(r)(p(n),"white"===e.orientation)),S(i,!0)),ey(e)}else l&&$(e),h&&D(e);e.dom.redraw()}(i,e))});r.addEventListener("touchstart",o,{passive:!1}),r.addEventListener("mousedown",o,{passive:!1})}(d,u),o||(d.dom.unbind=function(e,t){let i=[];if("ResizeObserver"in window||i.push(eV(document.body,"chessground.resize",t)),!e.viewOnly){let t=eZ(e,eC,eb),r=eZ(e,eS,ev);for(let e of["touchmove","mousemove"])i.push(eV(document,e,t));for(let e of["touchend","mouseup"])i.push(eV(document,e,r));let o=()=>e.dom.bounds.clear();i.push(eV(document,"scroll",o,{capture:!0,passive:!0})),i.push(eV(window,"resize",o,{passive:!0}))}return()=>i.forEach(e=>e())}(d,u)),d.events.insert&&d.events.insert(n),d}el(r,t||{});var n=o();function s(){n.orientation=v(n.orientation),n.animation.current=n.draggable.current=n.selected=void 0,o()}return{set(e){e.orientation&&e.orientation!==n.orientation&&s(),ea(n,e),(e.fen?eu:ed)(t=>el(t,e),n)},state:n,getFen:()=>{var e;return e=n.pieces,u.map(t=>h.map(i=>{let r=e.get(i+t);if(!r)return"1";{let e=en[r.role];return"white"===r.color&&(e=e.toUpperCase()),r.promoted&&(e+="~"),e}}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())},toggleOrientation:s,setPieces(e){eu(t=>(function(e,t){for(let[i,r]of t)r?e.pieces.set(i,r):e.pieces.delete(i)})(t,e),n)},selectSquare(e,t){e?eu(i=>z(i,e,t),n):n.selected&&(G(n),n.dom.redraw())},move(e,t){eu(i=>F(i,e,t),n)},newPiece(e,t){eu(i=>B(i,e,t),n)},playPremove(){if(n.premovable.current){if(eu(J,n))return!0;n.dom.redraw()}return!1},playPredrop(e){if(n.predroppable.current){let t=function(e,t){let i=e.predroppable.current,r=!1;if(!i)return!1;if(t(i)){let t={role:i.role,color:e.movable.color};B(e,t,i.key)&&(K(e.movable.events.afterNewPiece,i.role,i.key,{premove:!1,predrop:!0}),r=!0)}return D(e),r}(n,e);return n.dom.redraw(),t}return!1},cancelPremove(){ed($,n)},cancelPredrop(){ed(D,n)},cancelMove(){ed(e=>{ee(e),ex(e)},n)},stop(){ed(e=>{et(e),ex(e)},n)},explode(e){n.exploding={stage:1,keys:e},n.dom.redraw(),setTimeout(()=>{eA(n,2),setTimeout(()=>eA(n,void 0),120)},120)},setAutoShapes(e){ed(t=>t.drawable.autoShapes=e,n)},setShapes(e){ed(t=>t.drawable.shapes=e.slice(),n)},getKeyAtDomPos:e=>ei(e,"white"===n.orientation,n.dom.bounds()),redrawAll:o,dragNewPiece(e,t,i){let r;n.pieces.set("a0",e),n.dom.redraw(),r=x(t),n.draggable.current={orig:"a0",piece:e,origPos:r,pos:r,started:!0,element:()=>eM(n,"a0"),originTarget:t.target,newPiece:!0,force:!!i,keyHasChanged:!1},ey(n)},destroy(){et(n),n.dom.unbind&&n.dom.unbind(),n.dom.destroyed=!0}}}(e9.current,{fen:q.fen(),turnColor:eo,orientation:X||"white",movable:{color:tr||to?X:null,free:!1,dests:tr?tn():new Map,events:{after:ta}},draggable:{showGhost:!0,deleteOnDropOff:!0},animation:{enabled:!0,duration:300},highlight:{lastMove:!0,check:!0},premovable:{enabled:!1},drawable:{enabled:!0}})),()=>{te.current&&(te.current.destroy(),te.current=null,tt.current=!1)}),[]),(0,a.useEffect)(()=>{if(!te.current)return;let e=ts();te.current.set({fen:q.fen(),turnColor:eo,orientation:X||"white",movable:{color:!e.gameOver&&tr&&to?X:null,free:!1,dests:e.gameOver||!tr?new Map:tn(),events:{after:ta}},check:e.isCheck,lastMove:ec,animation:{enabled:!0,duration:300}}),eg(e),e.gameOver&&"finished"!==U.status&&s.emit("game over",{gameId:d,login:t.login,token:t.token}),"finished"===U.status&&e5(!0)},[q,eo,tr,to,X,ec,ts,tn,ta]),(0,a.useEffect)(()=>{let e=e=>{if(d in e){R&&N(!1),E&&T(!1);let t=e[d];if(W(t),t.moves.pgn!==Q&&t.moves.pgn.length>Q.length){V(t.moves.pgn);let e=new tA;e.loadPgn(t.moves.pgn);let i=e.history({verbose:!0});if(i.length>0){let e=i[i.length-1];ef([e.from,e.to])}j(e)}}else m?E||T(!0):R||N(!0)};return s.on("list of games",e),()=>{s.off("list of games",e)}},[s,d,Q,m]),(0,a.useEffect)(()=>{if(Q){let e=new tA;try{e.loadPgn(Q),j(e)}catch(e){console.error("Error loading PGN:",e)}}},[Q]),R)?(0,i.jsx)(tT.Backdrop,{sx:e=>({color:"#fff",zIndex:e.zIndex.drawer+1}),open:!0,children:(0,i.jsxs)(tO.Box,{sx:{display:"flex",alignItems:"center",flexDirection:"column",gap:"24px"},children:[(0,i.jsxs)(tj.Stack,{spacing:2,direction:"column",sx:{p:3},children:[(0,i.jsx)(tK.Typography,{variant:"h6",children:(0,tH.default)("errorLoadingPageTitle",t.language)}),(0,i.jsx)(tK.Typography,{variant:"subtitle1",children:(0,tH.default)("errorLoadingPageDescription",t.language)})]}),(0,i.jsxs)(tj.Stack,{spacing:2,direction:"column",children:[(0,i.jsx)(tL.Button,{variant:"contained",onClick:()=>e.push("/online-games-portal/"),children:(0,tH.default)("toMainPage",t.language)}),(0,i.jsx)(tL.Button,{variant:"outlined",onClick:e=>void window.location.reload(),children:(0,tH.default)("reload",t.language)})]})]})}):(0,i.jsxs)(n.ThemeProvider,{theme:tV,defaultMode:"dark",noSsr:!0,children:[(0,i.jsx)(tT.Backdrop,{sx:e=>({color:"#fff",zIndex:e.zIndex.drawer+1}),open:E,children:(0,i.jsx)(tR.CircularProgress,{disableShrink:!0,color:"inherit"})}),(0,i.jsx)(tO.Box,{sx:{width:"100%"},children:(0,i.jsx)(tU.default,{type:"game",gameId:d,gameInfo:U,handleSetIsUserLeftGame:e=>{w(!0),m!==e&&w(e)}})}),(!t.login||!X)&&!E&&(0,i.jsx)(tO.Box,{sx:{width:"100%"},children:(0,i.jsx)(tP.Alert,{severity:"info",sx:{m:1},variant:"outlined",icon:(0,i.jsx)(tD.default,{fontSize:"inherit"}),children:(0,tH.default)("spectatorMode",t.language)})}),(0,i.jsx)(tO.Box,{sx:{p:1},display:"flex",justifyContent:"start",children:(0,i.jsxs)(tj.Stack,{direction:"row",spacing:1,sx:{alignItems:"center"},children:[("white"===X&&"b"===q.turn()||"black"===X&&"w"===q.turn())&&"finished"!==U.status?U.players?.black?(0,i.jsx)(t$.default,{size:16,color:"success",sx:{width:"16px",height:"16px"}}):(0,i.jsx)(tR.CircularProgress,{size:"1em",color:""}):U.players?.black?(0,i.jsx)(t$.default,{size:16,color:"success",sx:{width:"16px",height:"16px"}}):(0,i.jsx)(t$.default,{size:16,color:"disabled",sx:{width:"16px",height:"16px"}}),(0,i.jsx)(tK.Typography,{variant:"body1",sx:{color:"rgb(186, 186, 186)",fontWeight:"bold"},children:"black"===X?U.players?.white?U.players.white:"finished"===U.status?(0,i.jsx)(i.Fragment,{children:q.getHeaders()?.White?q.getHeaders()?.White:""}):(0,i.jsx)(i.Fragment,{children:(0,tH.default)("waitingForOpponent",t.language)}):U.players?.black?"Computer"===U.players.black?(0,i.jsx)(i.Fragment,{children:(0,tH.default)("computer",t.language)}):U.players.black:"finished"===U.status?(0,i.jsx)(i.Fragment,{children:q.getHeaders()?.Black?q.getHeaders()?.Black:""}):(0,i.jsx)(i.Fragment,{children:(0,tH.default)("waitingForOpponent",t.language)})}),("white"===X&&"b"===q.turn()||"black"===X&&"w"===q.turn())&&"finished"!==U.status?(0,i.jsx)(tI.Chip,{label:(0,tH.default)("waitingForOpponent",t.language),size:"small",variant:"outlined"}):"finished"===U.status?("white"!==X||U.players.black)&&("black"!==X||U.players.white)?"":(0,i.jsx)(tI.Chip,{label:(0,tH.default)("opponentLeftTheGame",t.language),size:"small",variant:"outlined"}):""]})}),(0,i.jsx)(tO.Box,{sx:{width:"100%"},children:(0,i.jsx)("div",{ref:e9})}),(0,i.jsx)(tO.Box,{sx:{p:1},display:"flex",justifyContent:"start",children:(0,i.jsxs)(tj.Stack,{direction:"row",spacing:1,sx:{alignItems:"center"},children:[(0,i.jsx)(t$.default,{size:16,color:"success",sx:{width:"16px",height:"16px"}}),(0,i.jsx)(tK.Typography,{variant:"body1",sx:{color:"rgb(186, 186, 186)",fontWeight:"bold"},children:"white"===X?U.players.white:"black"===X?U.players?.black:U.players?.white||""}),"white"===X&&"w"===q.turn()||"black"===X&&"b"===q.turn()?(0,i.jsx)(tI.Chip,{label:(0,tH.default)("yourTurn",t.language),size:"small",variant:"outlined"}):""]})}),(0,i.jsx)(tO.Box,{sx:{width:"100%",p:1},children:(0,i.jsx)(tN.Paper,{sx:{width:"100%",overflow:"hidden",p:1,textAlign:"center"},children:ep&&!ep.gameOver&&"finished"!==U.status?ep.status:ep?.gameOver?(U.status,ep.status):"finished"===U.status?U.players.black?`${(0,tH.default)("whiteLeftTheGame",t.language)}`:`${(0,tH.default)("blackLeftTheGame",t.language)}`:ep?.status})}),(0,i.jsx)(tO.Box,{sx:{width:"100%",p:1},children:(0,i.jsx)(tW.default,{pgn:Q,fen:q.fen()})}),(0,i.jsx)(tq.Snackbar,{open:e4,autoHideDuration:6e3,onClose:e7,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:(0,i.jsx)(tP.Alert,{onClose:e7,severity:"info",variant:"filled",sx:{width:"100%"},children:U?.result?.startsWith("black")?(0,i.jsx)(i.Fragment,{children:(0,tH.default)("blackWinsGame",t.language)}):U?.result?.startsWith("white")?(0,i.jsx)(i.Fragment,{children:(0,tH.default)("whiteWinsGame",t.language)}):U?.result?.startsWith("draw")?(0,i.jsx)(i.Fragment,{children:(0,tH.default)("draw",t.language)}):ep?.status})})]})}e.s(["default",0,function(e){let t,o,n=(0,r.c)(3),{children:s}=e;return n[0]===Symbol.for("react.memo_cache_sentinel")?(t=(0,i.jsx)(tG.default,{}),n[0]=t):t=n[0],n[1]!==s?(o=(0,i.jsx)(a.Suspense,{fallback:t,children:(0,i.jsx)(tX,{children:s})}),n[1]=s,n[2]=o):o=n[2],o}],8037)}]);